# ダビマス更新の週次バッチ:
# 1) 最新情報取得 2) 画像生成 3) JSON更新 4) リポジトリ反映 5) X投稿
name: Weekly Dabimas Update

on:
  # GitHub Actions 画面から手動実行
  workflow_dispatch:
  schedule:
    # cron は UTC 指定: 毎週金曜 09:15 UTC (= 18:15 JST)
    - cron: "15 9 * * 5"

permissions:
  # JSON 更新結果を commit/push するために必要
  contents: write

concurrency:
  # 同時多重実行を避ける（先行ジョブはキャンセルしない）
  group: weekly-dabimas-update
  cancel-in-progress: false

jobs:
  weekly-pipeline:
    # 実行環境と制限時間
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # リポジトリのコードを runner に取得
      - uses: actions/checkout@v4

      # Python 実行環境を準備
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # スクリプト実行に必要な依存関係をインストール
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # 最新の種牡馬情報を収集してテキスト化
      - name: Fetch latest news
        run: |
          python scripts/fetch_latest_news.py --out latest_stallions.txt

      # 取得したテキストを投稿用画像に変換
      - name: Render latest stallions image
        run: |
          python scripts/txt_to_png.py \
            --input latest_stallions.txt \
            --output latest_stallions.png

      # 公開用 json/dabimasFactor.json を生成
      - name: Build dabimasFactor.json
        run: |
          python scripts/build_dabimas_stream.py \
            --output json/dabimasFactor.json \
            --progress 200 \
            --fail-on-error

      # service-worker.js の CACHE_NAME を dabimas-factor-vYYYYMMDD-01 へ更新
      - name: Update CACHE_NAME in service-worker.js
        run: |
          python - <<'PY'
          import re
          from datetime import datetime
          from pathlib import Path
          from zoneinfo import ZoneInfo

          sw_path = Path("service-worker.js")
          src = sw_path.read_text(encoding="utf-8")

          ymd = datetime.now(ZoneInfo("Asia/Tokyo")).strftime("%Y%m%d")
          cache_name = f"dabimas-factor-v{ymd}-01"

          updated, count = re.subn(
              r"(?m)^var CACHE_NAME = '.*';$",
              f"var CACHE_NAME = '{cache_name}';",
              src,
              count=1,
          )
          if count != 1:
              raise RuntimeError("CACHE_NAME line was not found in service-worker.js")

          sw_path.write_text(updated, encoding="utf-8")
          print(f"Updated CACHE_NAME: {cache_name}")
          PY

      # json と service-worker.js を同じコミットで main に反映
      - name: Commit and push JSON + service-worker cache name
        run: |
          TODAY="$(TZ=Asia/Tokyo date +'%Y-%m-%d')"
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add json/dabimasFactor.json service-worker.js

          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "Update json/dabimasFactor.json and CACHE_NAME (${TODAY})"
            git push
          fi

      # 画像付きで X に投稿
      - name: Post to X
        id: post_to_x
        env:
          # X API の認証情報（リポジトリ Secrets）
          X_CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          X_REFRESH_TOKEN: ${{ secrets.X_REFRESH_TOKEN }}
          # 投稿本文
          X_TWEET_TEXT: |
            ダビふぁくのデータを更新しました。
            追加データは添付画像をご確認ください。
            #ダビマス
          # 添付画像ファイル
          X_MEDIA_PATH: latest_stallions.png
        run: |
          python scripts/post_to_x.py

      # Refresh token を Secrets にローテーション保存
      - name: Rotate X refresh token in GitHub Secrets
        if: ${{ always() && steps.post_to_x.outputs.new_refresh_token != '' }}
        env:
          GH_SECRETS_TOKEN: ${{ secrets.GH_SECRETS_TOKEN }}
          NEW_X_REFRESH_TOKEN: ${{ steps.post_to_x.outputs.new_refresh_token }}
        run: |
          python scripts/update_repo_secret.py \
            --secret-name X_REFRESH_TOKEN \
            --secret-value-env NEW_X_REFRESH_TOKEN

