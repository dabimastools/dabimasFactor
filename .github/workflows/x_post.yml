# ダビマス更新の週次バッチ:
# 1) 最新情報取得 2) 画像生成 3) JSON更新 4) リポジトリ反映 5) X投稿
name: Weekly Dabimas Update

on:
  # GitHub Actions 画面から手動実行
  workflow_dispatch:
  schedule:
    # cron は UTC 指定: 毎週金曜 09:15 UTC (= 18:15 JST)
    - cron: "15 9 * * 5"

permissions:
  # JSON 更新結果を commit/push するために必要
  contents: write

concurrency:
  # 同時多重実行を避ける（先行ジョブはキャンセルしない）
  group: weekly-dabimas-update
  cancel-in-progress: false

jobs:
  weekly-pipeline:
    # 実行環境と制限時間
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      # リポジトリのコードを runner に取得
      - uses: actions/checkout@v4

      # Python 実行環境を準備
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # スクリプト実行に必要な依存関係をインストール
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r scripts/requirements.txt

      # 最新の種牡馬情報を収集してテキスト化
      - name: Fetch latest news
        run: |
          python scripts/fetch_latest_news.py --out latest_stallions.txt

      # 取得したテキストを投稿用画像に変換
      - name: Render latest stallions image
        run: |
          python scripts/txt_to_png.py \
            --input latest_stallions.txt \
            --output latest_stallions.png

      # 公開用 dabimasFactor.json を生成
      - name: Build dabimasFactor.json
        run: |
          python scripts/build_dabimas_stream.py \
            --output dabimasFactor.json \
            --progress 200 \
            --fail-on-error

      # 生成した JSON を main ブランチの json/ に反映
      - name: Push dabimasFactor.json to main/json
        env:
          # GitHub Actions が自動発行するトークン
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # コミットメッセージの日付は JST で統一
          TODAY="$(TZ=Asia/Tokyo date +'%Y-%m-%d')"
          python scripts/push_json_action.py \
            --local-file dabimasFactor.json \
            --dest-path json/dabimasFactor.json \
            --message "Update json/dabimasFactor.json (${TODAY})"

      # 画像付きで X に投稿
      - name: Post to X
        env:
          # X API の認証情報（リポジトリ Secrets）
          X_CLIENT_ID: ${{ secrets.X_CLIENT_ID }}
          X_REFRESH_TOKEN: ${{ secrets.X_REFRESH_TOKEN }}
          # 投稿本文
          X_TWEET_TEXT: |
            ダビふぁくのデータを更新しました。
            追加データは添付画像をご確認ください。
            #ダビマス
          # 添付画像ファイル
          X_MEDIA_PATH: latest_stallions.png
        run: |
          python scripts/post_to_x.py

