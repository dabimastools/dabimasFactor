name: Build Dabimas Stream

on:
  workflow_dispatch:
    inputs:
      delay:
        description: "Delay seconds between requests"
        required: false
        default: "0"
      limit:
        description: "Process first N URLs only (0 = all)"
        required: false
        default: "0"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build JSON
        run: |
          mkdir -p artifacts
          python build_dabimas_stream.py \
            --output artifacts/dabimasFactor.json \
            --all-output artifacts/all_rows.ndjson \
            --delay "${{ github.event.inputs.delay || '0' }}" \
            --limit "${{ github.event.inputs.limit || '0' }}" \
            --progress 200 \
            --fail-on-error

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dabimas-stream
          path: artifacts/
